<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Application Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4A5E54;
      --secondary-color: #E5E5E5;
      --accent-color: #F5F5F0;
      --text-color: #333333;
      --card-bg: #FFFFFF;
      --table-bg: #F9FAFB;
      --table-hover: #E5E5E5;
      --input-bg: #FFFFFF;
      --button-bg: #4A5E54;
      --button-hover: #3A4E44;
      --modal-bg: #FFFFFF;
      --success-color: #28A745;
      --warning-color: #FFC107;
      --danger-color: #DC3545;
      --info-color: #17A2B8;
    }
    [data-theme="dark"] {
      --primary-color: #6A7E74;
      --secondary-color: #C5C5C5;
      --accent-color: #D5D5C0;
      --text-color: #E5E5E5;
      --card-bg: #2C3E50;
      --table-bg: #34495E;
      --table-hover: #465C71;
      --input-bg: #2C3E50;
      --button-bg: #6A7E74;
      --button-hover: #5A6E64;
      --modal-bg: #2C3E50;
    }
    body {
      background: var(--accent-color);
      color: var(--text-color);
      font-family: 'Roboto', 'Segoe UI', Tahoma, sans-serif;
      line-height: 1.6;
      transition: all 0.3s ease;
    }
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      color: var(--text-color);
    }
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--secondary-color);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .card-header {
      background: var(--primary-color);
      color: #FFFFFF;
      border-radius: 12px 12px 0 0;
      padding: 1.25rem;
      font-weight: 500;
    }
    .card-body {
      padding: 1.75rem;
    }
    .table {
      background-color: var(--table-bg);
      color: var(--text-color);
      border-radius: 8px;
      overflow: hidden;
    }
    .table thead th {
      background-color: var(--primary-color);
      color: #FFFFFF;
      border: none;
    }
    .table tbody tr {
      background-color: var(--card-bg);
      transition: background-color 0.2s ease;
    }
    .table-hover tbody tr:hover {
      background-color: var(--table-hover);
    }
    .status-badge {
      font-size: 0.8rem;
      padding: 0.4em 0.8em;
      font-weight: 500;
      border-radius: 20px;
      text-transform: uppercase;
      color: #FFFFFF !important;
    }
    .badge-applied { background-color: var(--primary-color); }
    .badge-interview { background-color: var(--info-color); }
    .badge-offer { background-color: var(--success-color); }
    .badge-rejected { background-color: var(--danger-color); }
    .toast-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1200;
    }
    .toast {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .attachment-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 6px;
      background-color: rgba(0,0,0,0.03);
      margin-bottom: 8px;
      transition: background-color 0.2s ease;
    }
    .attachment-item:hover {
      background-color: rgba(0,0,0,0.06);
    }
    .attachment-icon {
      margin-right: 10px;
      color: var(--primary-color);
    }
    .attachment-dropzone {
      border: 2px dashed var(--secondary-color);
      padding: 20px;
      text-align: center;
      background: var(--input-bg);
      border-radius: 8px;
      transition: border-color 0.3s ease;
    }
    .attachment-dropzone.dragover {
      border-color: var(--primary-color);
      background: rgba(74, 94, 84, 0.1);
    }
    @media (max-width: 768px) {
      .optional-column { display: none; }
    }
    .form-control, .form-select {
      background-color: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--secondary-color);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(74, 94, 84, 0.3);
      outline: none;
    }
    .form-control.is-invalid, .form-select.is-invalid {
      border-color: var(--danger-color);
    }
    .form-control.is-valid, .form-select.is-valid {
      border-color: var(--success-color);
    }
    .form-control::placeholder {
      color: var(--text-color);
      opacity: 0.6;
    }
    .form-label {
      font-weight: 500;
      color: var(--text-color);
      margin-bottom: 0.4rem;
    }
    .btn-outline-secondary {
      background-color: var(--button-bg);
      color: #FFFFFF;
      border-color: var(--button-bg);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .btn-outline-secondary:hover {
      background-color: var(--button-hover);
      color: #FFFFFF;
      transform: translateY(-2px);
    }
    .btn-success, .btn-primary {
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      color: #FFFFFF;
      padding: 0.6rem 1.2rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-success:hover, .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      background: var(--button-hover);
    }
    .btn-sm {
      padding: 0.3rem 0.8rem;
    }
    .input-group-text {
      background-color: var(--input-bg);
      color: var(--text-color);
      border-color: var(--secondary-color);
    }
    .milestone-modal .modal-content {
      background: linear-gradient(135deg, #FFD700, #FFEB3B);
      color: #333333;
      border-radius: 12px;
      text-align: center;
    }
    .sidebar {
      height: 100vh;
      background: var(--card-bg);
      border-right: 1px solid var(--secondary-color);
      padding: 2rem 1rem;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      width: 250px;
    }
    .sidebar .nav-link {
      color: var(--text-color);
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    .sidebar .nav-link:hover {
      background-color: var(--table-hover);
      color: var(--primary-color);
    }
    .sidebar .nav-link.active {
      background-color: var(--primary-color);
      color: #FFFFFF;
      font-weight: 600;
    }
    .modal-content {
      background-color: var(--modal-bg);
      color: var(--text-color);
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .modal-header {
      background: var(--primary-color);
      color: #FFFFFF;
      border-radius: 12px 12px 0 0;
      padding: 1.5rem;
    }
    .modal-footer {
      background-color: var(--modal-bg);
      padding: 1rem;
      border-radius: 0 0 12px 12px;
    }
    .modal-header .btn-close {
      filter: brightness(200%);
    }
    .modal.fade .modal-dialog {
      transition: transform 0.3s ease-out;
      transform: translateY(-30px);
    }
    .modal.show .modal-dialog {
      transform: translateY(0);
    }
    canvas {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
    }
    .progress {
      background-color: var(--secondary-color);
      border-radius: 20px;
      height: 1rem;
    }
    .progress-bar {
      border-radius: 20px;
      transition: width 0.5s ease-in-out;
    }
    .accordion-button {
      background-color: var(--card-bg);
      color: var(--text-color);
      font-weight: 500;
      border-radius: 8px !important;
    }
    .accordion-button:not(.collapsed) {
      background-color: var(--primary-color);
      color: #FFFFFF;
    }
    .spinner-border {
      width: 2.5rem;
      height: 2.5rem;
    }
    .viz-card {
      height: 300px;
      display: flex;
      flex-direction: column;
      margin-bottom: 1rem;
    }
    .viz-card .card-body {
      flex: 1;
      overflow: hidden;
      padding: 1rem;
    }
    canvas {
      max-height: 100%;
      width: 100%;
    }
    .row.g-3 {
      margin-bottom: 1rem;
    }
    .streak-counter {
      font-size: 0.9rem;
      color: var(--success-color);
      margin-top: 1rem;
    }
    .tab-pane#analytics {
      max-height: 80vh;
      overflow-y: auto;
      padding-bottom: 1rem;
    }
    @media (max-width: 576px) {
      .viz-card {
        height: 250px;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div class="container-fluid my-4">
    <div class="row">
      <!-- Sidebar Navigation -->
      <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#tracker" data-bs-toggle="tab" role="tab" aria-controls="tracker">
                <i class="fas fa-tasks me-2"></i><span>Tracker</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#analytics" data-bs-toggle="tab" role="tab" aria-controls="analytics">
                <i class="fas fa-chart-pie me-2"></i><span>Analytics</span>
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <button class="btn btn-outline-secondary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-expanded="false" aria-controls="sidebar">
            <i class="fas fa-bars"></i>
          </button>
          <h1 class="mb-0"><i class="fas fa-briefcase me-2"></i>Job Application Tracker</h1>
          <button id="themeToggle" class="btn btn-outline-secondary" aria-label="Toggle theme">
            <i class="fas fa-moon"></i> Toggle Theme
          </button>
        </div>

        <!-- Recovery Alert -->
        <div id="recoveryAlert" class="alert alert-warning d-none" role="alert">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-exclamation-triangle me-2"></i>
              <span id="recoveryMessage">Potential data recovery available</span>
            </div>
            <button id="recoveryBtn" class="btn btn-sm btn-outline-dark">Attempt Recovery</button>
          </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="d-none text-center py-4">
          <div class="spinner-border" style="color: var(--primary-color);" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="appTabContent">
          <!-- Tracker Tab -->
          <div class="tab-pane fade show active" id="tracker" role="tabpanel" aria-labelledby="tracker-tab">
            <!-- Goal Tracking Card -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Application Goals</h5>
              </div>
              <div class="card-body">
                <div class="row g-4">
                  <div class="col-md-4">
                    <p>Total Goal: <span id="applicationGoal">100</span> applications</p>
                    <div class="progress">
                      <div id="goalProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <p>Weekly Goal: <span id="weeklyGoal">5</span> applications</p>
                    <div class="progress">
                      <div id="weeklyProgress" class="progress-bar" style="background-color: var(--primary-color);" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <p>Monthly Goal: <span id="monthlyGoal">20</span> applications</p>
                    <div class="progress">
                      <div id="monthlyProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary mt-4" data-bs-toggle="modal" data-bs-target="#goalModal">Set Goals</button>
                <div id="streakCounter" class="streak-counter">Weekly Streak: 0 weeks</div>
              </div>
            </div>

            <!-- Add New Application Form -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New Application</h5>
              </div>
              <div class="card-body">
                <form id="jobForm" novalidate>
                  <div class="row g-4">
                    <div class="col-md-4">
                      <label class="form-label">Company*</label>
                      <input type="text" id="company" class="form-control" required aria-required="true">
                      <div class="invalid-feedback">Company is required.</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Position*</label>
                      <input type="text" id="position" class="form-control" required aria-required="true">
                      <div class="invalid-feedback">Position is required.</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Date Applied*</label>
                      <input type="date" id="dateApplied" class="form-control" required aria-required="true">
                      <div class="invalid-feedback">Date is required.</div>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Job Type*</label>
                      <select id="type" class="form-select" required aria-required="true">
                        <option value="Onsite">Onsite</option>
                        <option value="Remote">Remote</option>
                        <option value="Hybrid">Hybrid</option>
                      </select>
                      <div class="invalid-feedback">Job type is required.</div>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Location</label>
                      <input type="text" id="location" class="form-control">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Salary</label>
                      <input type="text" id="salary" class="form-control" placeholder="e.g. $60,000/year">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Job Source</label>
                      <input type="text" id="jobSource" class="form-control" list="jobSources" placeholder="e.g. LinkedIn">
                      <datalist id="jobSources">
                        <option value="LinkedIn">
                        <option value="Indeed">
                        <option value="Glassdoor">
                        <option value="Company Website">
                      </datalist>
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Job Posting URL</label>
                      <div class="input-group">
                        <input type="url" id="jobUrl" class="form-control" placeholder="e.g. https://example.com/job">
                        <button type="button" class="btn btn-outline-secondary" onclick="window.open(document.getElementById('jobUrl').value, '_blank')" aria-label="Open job URL">
                          <i class="fas fa-external-link-alt"></i>
                        </button>
                      </div>
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Notes</label>
                      <textarea id="notes" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Attachments</label>
                      <div id="attachmentsContainer" class="mb-3"></div>
                      <div class="attachment-dropzone" id="attachmentDropzone" aria-label="Drop files here or click to upload">
                        Drop files here or click to upload
                        <input type="file" id="attachmentInput" class="form-control d-none" multiple>
                      </div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                      <i class="fas fa-plus me-2"></i> Add Application
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Backup and Filters -->
            <div class="row mb-4 g-3">
              <div class="col-md-3">
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  <input type="text" id="searchInput" class="form-control" placeholder="Search applications..." aria-label="Search applications">
                  <button class="btn btn-outline-secondary" type="button" id="clearSearch" aria-label="Clear search">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-9">
                <div class="d-flex justify-content-end gap-2">
                  <button id="backupDataBtn" class="btn btn-outline-secondary">
                    <i class="fas fa-save me-2"></i> Save Backup
                  </button>
                  <button id="importDataBtn" class="btn btn-outline-secondary">
                    <i class="fas fa-file-import me-2"></i> Import
                  </button>
                  <input type="file" id="importFileInput" style="display: none;" accept=".json">
                  <button id="exportJSON" class="btn btn-outline-secondary">
                    <i class="fas fa-file-export me-2"></i> Export JSON
                  </button>
                  <button id="exportPDF" class="btn btn-outline-secondary">
                    <i class="fas fa-file-pdf me-2"></i> Export PDF
                  </button>
                </div>
              </div>
            </div>

            <!-- Applications Tables -->
            <div class="accordion" id="applicationsAccordion">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#activeCollapse" aria-expanded="true" aria-controls="activeCollapse">
                    Active Applications
                  </button>
                </h2>
                <div id="activeCollapse" class="accordion-collapse collapse show" aria-labelledby="activeHeading">
                  <div class="accordion-body p-0">
                    <div class="table-responsive">
                      <table id="activeApplicationsTable" class="table table-hover">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Company</th>
                            <th>Position</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th class="salary-column">Salary</th>
                            <th class="optional-column">Source</th>
                            <th>Status</th>
                            <th>URL</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rejectedCollapse" aria-expanded="false" aria-controls="rejectedCollapse">
                    Rejected Applications
                  </button>
                </h2>
                <div id="rejectedCollapse" class="accordion-collapse collapse" aria-labelledby="rejectedHeading">
                  <div class="accordion-body p-0">
                    <div class="table-responsive">
                      <table id="rejectedApplicationsTable" class="table table-hover">
                        <thead>
                          <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Company</th>
                            <th>Position</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th class="salary-column">Salary</th>
                            <th class="optional-column">Source</th>
                            <th>Status</th>
                            <th>URL</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pagination -->
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
          </div>

          <!-- Analytics Tab -->
          <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
            <div class="row mb-4">
              <div class="col-md-6">
                <label class="form-label">Date Range for Analytics</label>
                <div class="input-group">
                  <input type="date" id="analyticsStartDate" class="form-control" aria-label="Analytics start date">
                  <input type="date" id="analyticsEndDate" class="form-control" aria-label="Analytics end date">
                </div>
              </div>
              <div class="col-md-6 d-flex justify-content-end gap-2">
                <button id="clearFiltersBtn" class="btn btn-outline-secondary">
                  <i class="fas fa-times me-2"></i> Clear Filters
                </button>
                <button id="exportStatusChart" class="btn btn-outline-secondary">
                  <i class="fas fa-download me-2"></i> Export Status
                </button>
              </div>
            </div>
            <div class="row g-4">
              <!-- Status Distribution -->
              <div class="col-lg-6">
                <div class="card viz-card h-100">
                  <div class="card-header">
                    <h5><i class="fas fa-chart-pie me-2"></i>Application Status</h5>
                  </div>
                  <div class="card-body">
                    <canvas id="statusChart" aria-label="Application status distribution"></canvas>
                  </div>
                </div>
              </div>

              <!-- Success Rate -->
              <div class="col-lg-6">
                <div class="card viz-card h-100">
                  <div class="card-header">
                    <h5><i class="fas fa-percentage me-2"></i>Success Rate</h5>
                  </div>
                  <div class="card-body text-center">
                    <h2 id="successRate">0%</h2>
                    <p>Percentage of applications reaching "Offer" status</p>
                  </div>
                </div>
              </div>

              <!-- Job Type Distribution -->
              <div class="col-lg-6">
                <div class="card viz-card h-100">
                  <div class="card-header">
                    <h5><i class="fas fa-laptop-house me-2"></i>Job Type Distribution</h5>
                  </div>
                  <div class="card-body">
                    <canvas id="typeChart" aria-label="Job type distribution"></canvas>
                  </div>
                </div>
              </div>

              <!-- Success Rate by Job Source -->
              <div class="col-lg-6">
                <div class="card viz-card h-100">
                  <div class="card-header">
                    <h5><i class="fas fa-link me-2"></i>Success Rate by Job Source</h5>
                  </div>
                  <div class="card-body">
                    <canvas id="sourceSuccessChart" aria-label="Success rate by job source"></canvas>
                  </div>
                </div>
              </div>

              <!-- Average Response Time -->
              <div class="col-lg-6">
                <div class="card viz-card h-100">
                  <div class="card-header">
                    <h5><i class="fas fa-clock me-2"></i>Average Response Time</h5>
                  </div>
                  <div class="card-body text-center">
                    <h2 id="avgResponseTime">-</h2>
                    <p>Days from Applied to Interview</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Edit Application Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel"><i class="fas fa-edit me-2"></i>Edit Application</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editForm" novalidate>
            <div class="row g-4">
              <div class="col-md-6">
                <label class="form-label">Company*</label>
                <input type="text" id="editCompany" class="form-control" required aria-required="true">
                <div class="invalid-feedback">Company is required.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Position*</label>
                <input type="text" id="editPosition" class="form-control" required aria-required="true">
                <div class="invalid-feedback">Position is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date Applied*</label>
                <input type="date" id="editDateApplied" class="form-control" required aria-required="true">
                <div class="invalid-feedback">Date is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Job Type*</label>
                <select id="editType" class="form-select" required aria-required="true">
                  <option value="Onsite">Onsite</option>
                  <option value="Remote">Remote</option>
                  <option value="Hybrid">Hybrid</option>
                </select>
                <div class="invalid-feedback">Job type is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Status*</label>
                <select id="editStatus" class="form-select" required aria-required="true">
                  <option value="Applied">Applied</option>
                  <option value="Interview">Interview</option>
                  <option value="Offer">Offer</option>
                  <option value="Rejected">Rejected</option>
                </select>
                <div class="invalid-feedback">Status is required.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Location</label>
                <input type="text" id="editLocation" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Salary</label>
                <input type="text" id="editSalary" class="form-control" placeholder="e.g. $60,000/year">
              </div>
              <div class="col-md-6">
                <label class="form-label">Job Source</label>
                <input type="text" id="editJobSource" class="form-control" list="jobSources">
              </div>
              <div class="col-md-12">
                <label class="form-label">Job Posting URL</label>
                <div class="input-group">
                  <input type="url" id="editJobUrl" class="form-control" placeholder="e.g. https://example.com/job">
                  <button type="button" class="btn btn-outline-secondary" onclick="window.open(document.getElementById('editJobUrl').value, '_blank')" aria-label="Open job URL">
                    <i class="fas fa-external-link-alt"></i>
                  </button>
                </div>
              </div>
              <div class="col-md-12">
                <label class="form-label">Notes</label>
                <textarea id="editNotes" class="form-control" rows="3"></textarea>
              </div>
              <div class="col-md-12">
                <label class="form-label">Attachments</label>
                <div id="editAttachmentsContainer" class="mb-3"></div>
                <div class="attachment-dropzone" id="editAttachmentDropzone" aria-label="Drop files here or click to upload">
                  Drop files here or click to upload
                  <input type="file" id="editAttachmentInput" class="form-control d-none" multiple>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Recovery Modal -->
  <div class="modal fade" id="recoveryModal" tabindex="-1" aria-labelledby="recoveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="recoveryModalLabel">
            <i class="fas fa-ambulance me-2"></i>Data Recovery
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="recoveryOptions">
            <p class="mb-3">It looks like you might have lost some data. Choose a recovery source:</p>
            <div class="list-group mb-3">
              <button class="list-group-item list-group-item-action d-flex align-items-center" id="recoverFromOldDb" aria-label="Recover from previous database version">
                <i class="fas fa-database me-3"></i>
                <span>Recover from Previous Database Version</span>
              </button>
              <button class="list-group-item list-group-item-action d-flex align-items-center" id="recoverFromLocalStorage" aria-label="Recover from local storage">
                <i class="fas fa-save me-3"></i>
                <span>Recover from Local Storage Backup</span>
              </button>
            </div>
            <div class="alert alert-info d-flex align-items-center" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              <span>Selecting a recovery source will preview the data before applying changes.</span>
            </div>
          </div>
          <div id="recoveryResults" class="d-none">
            <h6 class="mb-3">Recovery Preview</h6>
            <div id="recoveryStats" class="mb-3 p-3 bg-light rounded">
              <p class="mb-1"><strong>Applications Found:</strong> <span id="recoveredAppCount">0</span></p>
              <p class="mb-0"><strong>Earliest Application:</strong> <span id="earliestDate">-</span></p>
            </div>
            <div class="d-flex justify-content-between">
              <button id="cancelRecovery" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button id="confirmRecovery" class="btn btn-success">Confirm Recovery</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Milestone Modal -->
  <div class="modal fade milestone-modal" id="milestoneModal" tabindex="-1" aria-labelledby="milestoneModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="milestoneMessage"><i class="fas fa-trophy me-2"></i>Milestone Achieved!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="milestoneMessageText">Congratulations! You've reached a milestone!</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Awesome!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Goal Setting Modal -->
  <div class="modal fade" id="goalModal" tabindex="-1" aria-labelledby="goalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="goalModalLabel">Set Application Goals</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="goalForm">
            <div class="mb-3">
              <label for="totalGoalInput" class="form-label">Total Application Goal</label>
              <input type="number" id="totalGoalInput" class="form-control" min="1" required>
              <div class="invalid-feedback">Please enter a valid number.</div>
            </div>
            <div class="mb-3">
              <label for="weeklyGoalInput" class="form-label">Weekly Application Goal</label>
              <input type="number" id="weeklyGoalInput" class="form-control" min="1" required>
              <div class="invalid-feedback">Please enter a valid number.</div>
            </div>
            <div class="mb-3">
              <label for="monthlyGoalInput" class="form-label">Monthly Application Goal</label>
              <input type="number" id="monthlyGoalInput" class="form-control" min="1" required>
              <div class="invalid-feedback">Please enter a valid number.</div>
            </div>
            <button type="submit" class="btn btn-primary">Save Goals</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <!-- JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    // Database Setup
    const db = new Dexie("JobApplicationsDB");
    db.version(34).stores({
      applications: "++id,company,position,[dateApplied+status],type,location,jobSource,jobUrl,status",
      backups: "++id,timestamp,data",
      goals: "id,totalGoal,weeklyGoal,monthlyGoal"
    });

    // Application State
    const state = {
      currentPage: 1,
      itemsPerPage: 10,
      currentEditId: null,
      filteredApplications: [],
      applications: [],
      statuses: ['Applied', 'Interview', 'Offer', 'Rejected'],
      jobTypes: ['Onsite', 'Remote', 'Hybrid'],
      charts: {},
      currentAttachments: [],
      editAttachments: [],
      recoveryData: null,
      milestones: [100, 150, 200],
      goals: { totalGoal: 100, weeklyGoal: 5, monthlyGoal: 20 },
      weeklyStreak: 0
    };

    // DOM Elements
    const activeTableBody = document.querySelector('#activeApplicationsTable tbody');
    const rejectedTableBody = document.querySelector('#rejectedApplicationsTable tbody');
    const pagination = document.getElementById('pagination');
    const jobForm = document.getElementById('jobForm');
    const editForm = document.getElementById('editForm');
    const editModal = new bootstrap.Modal('#editModal');
    const recoveryModal = new bootstrap.Modal('#recoveryModal');
    const milestoneModal = new bootstrap.Modal('#milestoneModal');
    const goalModal = new bootstrap.Modal('#goalModal');
    const toastContainer = document.getElementById('toastContainer');
    const recoveryAlert = document.getElementById('recoveryAlert');
    const recoveryBtn = document.getElementById('recoveryBtn');

    // Initialization
    document.addEventListener("DOMContentLoaded", async () => {
      if (!jobForm || !activeTableBody || !rejectedTableBody) {
        console.error('Critical DOM elements missing');
        return;
      }
      try {
        document.body.dataset.theme = localStorage.getItem('theme') || 'light';
        updateThemeDisplay();
        await db.open();
        await loadGoals();
        await loadApplications();
        initEventListeners();
        setupAutoBackup();
        loadDraft('jobForm', ['company', 'position', 'dateApplied', 'type', 'location', 'salary', 'jobSource', 'jobUrl', 'notes']);
      } catch (error) {
        console.error("Initialization failed:", error);
        showToast('Application failed to initialize', 'danger');
      }
    });

    // Theme Toggle
    function toggleTheme() {
      if (!state.charts.status || !state.charts.type || !state.charts.sourceSuccess) {
        showToast('Charts are still loading, please wait...', 'warning');
        return;
      }
      const newTheme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
      document.body.dataset.theme = newTheme;
      localStorage.setItem('theme', newTheme);
      updateThemeDisplay();
      updateCharts();
    }

    function updateThemeDisplay() {
      const theme = document.body.dataset.theme;
      const icon = document.getElementById('themeToggle').querySelector('i');
      icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      Object.values(state.charts).forEach(chart => {
        if (chart) {
          chart.options.plugins.legend.labels.color = theme === 'dark' ? '#E5E5E5' : '#333333';
          if (chart.config.type === 'bar') {
            chart.options.scales.x.ticks.color = theme === 'dark' ? '#E5E5E5' : '#333333';
            chart.options.scales.y.ticks.color = theme === 'dark' ? '#E5E5E5' : '#333333';
          }
          chart.update();
        }
      });
    }

    // Database Recovery Functions
    async function checkRecoveryOptions() {
      const currentAppCount = await db.applications.count();
      if (currentAppCount === 0 && localStorage.getItem('jobTrackerBackup')) {
        recoveryAlert.classList.remove('d-none');
      }
    }

    async function attemptRecovery() {
      recoveryModal.show();
    }

    // Goal Management Functions
    async function loadGoals() {
      await db.transaction('rw', db.goals, async () => {
        const goals = await db.goals.get(1);
        if (goals) {
          state.goals = {
            totalGoal: goals.totalGoal,
            weeklyGoal: goals.weeklyGoal,
            monthlyGoal: goals.monthlyGoal
          };
        } else {
          await db.goals.put({ id: 1, totalGoal: 100, weeklyGoal: 5, monthlyGoal: 20 });
        }
      });
      updateGoalDisplay();
    }

    function updateGoalDisplay() {
      document.getElementById('applicationGoal').textContent = state.goals.totalGoal;
      document.getElementById('weeklyGoal').textContent = state.goals.weeklyGoal;
      document.getElementById('monthlyGoal').textContent = state.goals.monthlyGoal;
      updateStreakCounter();
    }

    function updateProgressBars() {
      const appCount = state.applications.length;
      const totalProgress = Math.min((appCount / state.goals.totalGoal) * 100, 100);
      const totalProgressBar = document.getElementById('goalProgress');
      totalProgressBar.style.width = `${totalProgress}%`;
      totalProgressBar.setAttribute('aria-valuenow', totalProgress);
      totalProgressBar.textContent = `${Math.round(totalProgress)}%`;

      const now = new Date();
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      weekStart.setHours(0, 0, 0, 0);
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

      const weeklyApps = state.applications.filter(app => new Date(app.dateApplied) >= weekStart).length;
      const monthlyApps = state.applications.filter(app => new Date(app.dateApplied) >= monthStart).length;

      const weeklyProgress = Math.min((weeklyApps / state.goals.weeklyGoal) * 100, 100);
      const weeklyProgressBar = document.getElementById('weeklyProgress');
      weeklyProgressBar.style.width = `${weeklyProgress}%`;
      weeklyProgressBar.setAttribute('aria-valuenow', weeklyProgress);
      weeklyProgressBar.textContent = `${Math.round(weeklyProgress)}%`;

      const monthlyProgress = Math.min((monthlyApps / state.goals.monthlyGoal) * 100, 100);
      const monthlyProgressBar = document.getElementById('monthlyProgress');
      monthlyProgressBar.style.width = `${monthlyProgress}%`;
      monthlyProgressBar.setAttribute('aria-valuenow', monthlyProgress);
      monthlyProgressBar.textContent = `${Math.round(monthlyProgress)}%`;

      checkGoalProgress(weeklyApps, state.goals.weeklyGoal, 'weekly');
      checkGoalProgress(monthlyApps, state.goals.monthlyGoal, 'monthly');
    }

    function checkGoalProgress(current, goal, type) {
      const celebratedGoals = JSON.parse(localStorage.getItem(`celebrated${type}Goals`)) || [];
      if (current >= goal && !celebratedGoals.includes(goal)) {
        showToast(`Great job! You've reached your ${type} goal of ${goal} applications!`, 'success');
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 }
        });
        celebratedGoals.push(goal);
        localStorage.setItem(`celebrated${type}Goals`, JSON.stringify(celebratedGoals));
      } else if (current >= goal * 0.8 && current < goal) {
        showToast(`You're close to your ${type} goal! ${current}/${goal} applications submitted.`, 'info');
      }
    }

    function updateStreakCounter() {
      const now = new Date();
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      weekStart.setHours(0, 0, 0, 0);

      let streak = 0;
      let currentWeek = new Date(weekStart);
      while (true) {
        const weekApps = state.applications.filter(app => {
          const appDate = new Date(app.dateApplied);
          return appDate >= currentWeek && appDate < new Date(currentWeek.getTime() + 7 * 24 * 60 * 60 * 1000);
        }).length;
        if (weekApps >= state.goals.weeklyGoal) {
          streak++;
          currentWeek.setDate(currentWeek.getDate() - 7);
        } else {
          break;
        }
        if (currentWeek < new Date(state.applications[state.applications.length - 1]?.dateApplied)) break;
      }
      state.weeklyStreak = streak;
      document.getElementById('streakCounter').textContent = `Weekly Streak: ${streak} weeks`;
    }

    // Milestone Functions
    function checkMilestones(appCount) {
      const celebratedMilestones = JSON.parse(localStorage.getItem('celebratedMilestones')) || [];
      const reachedMilestone = state.milestones.find(milestone => appCount >= milestone && !celebratedMilestones.includes(milestone));

      if (reachedMilestone) {
        document.getElementById('milestoneMessageText').textContent = `Congratulations! You've reached ${reachedMilestone} applications!`;
        milestoneModal.show();
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 }
        });
        celebratedMilestones.push(reachedMilestone);
        localStorage.setItem('celebratedMilestones', JSON.stringify(celebratedMilestones));
      }
    }

    // Core Application Functions
    async function loadApplications() {
      document.getElementById('loadingSpinner').classList.remove('d-none');
      try {
        await db.transaction('r', db.applications, async () => {
          let apps = await db.applications.orderBy('dateApplied').reverse().toArray();
          apps = apps.map(app => ({
            ...app,
            status: state.statuses.includes(app.status) ? app.status : 'Applied',
            type: state.jobTypes.includes(app.type) ? app.type : 'Remote',
            salary: app.salary || '-',
            jobUrl: app.jobUrl || '',
            dateApplied: app.dateApplied
          }));
          state.applications = apps;
          state.filteredApplications = [...apps];
        });
        renderApplicationsTable();
        renderPagination();
        if (!state.charts.status) setupCharts();
        updateCharts();
        const appCount = state.applications.length;
        checkMilestones(appCount);
        updateProgressBars();
        await checkRecoveryOptions();
      } catch (error) {
        console.error('Error loading applications:', error);
        showToast('Failed to load applications', 'danger');
      } finally {
        document.getElementById('loadingSpinner').classList.add('d-none');
      }
    }

    function renderApplicationsTable() {
      if (!activeTableBody || !rejectedTableBody) return;
      activeTableBody.innerHTML = '';
      rejectedTableBody.innerHTML = '';
      const startIndex = (state.currentPage - 1) * state.itemsPerPage;
      const endIndex = startIndex + state.itemsPerPage;
      const paginatedApps = state.filteredApplications.slice(startIndex, endIndex);

      if (paginatedApps.length === 0) {
        activeTableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-muted">No applications found</td></tr>';
        rejectedTableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-muted">No rejected applications</td></tr>';
        return;
      }

      const activeApps = paginatedApps.filter(app => app.status !== 'Rejected');
      const rejectedApps = paginatedApps.filter(app => app.status === 'Rejected');

      [activeApps, rejectedApps].forEach((apps, idx) => {
        const tbody = idx === 0 ? activeTableBody : rejectedTableBody;
        if (apps.length === 0) {
          tbody.innerHTML = `<tr><td colspan="11" class="text-center py-4 text-muted">No ${idx === 0 ? 'active' : 'rejected'} applications</td></tr>`;
        } else {
          apps.forEach((app, index) => renderApplicationRow(tbody, app, startIndex + index + 1));
        }
      });
    }

    function renderApplicationRow(tableBody, app, appNumber) {
      const row = tableBody.insertRow();
      row.className = 'align-middle';
      const dateApplied = new Date(app.dateApplied);
      const formattedDate = new Date(dateApplied.getTime() + dateApplied.getTimezoneOffset() * 60000).toLocaleDateString();
      row.innerHTML = `
        <td>${appNumber}</td>
        <td>${formattedDate}</td>
        <td>${app.company || '-'}</td>
        <td>${app.position || '-'}</td>
        <td>${app.type || '-'}</td>
        <td>${app.location || '-'}</td>
        <td class="salary-column">${app.salary || '-'}</td>
        <td class="optional-column">${app.jobSource || '-'}</td>
        <td><span class="badge status-badge badge-${app.status.toLowerCase()}">${app.status}</span></td>
        <td>${app.jobUrl ? '<button class="btn btn-sm btn-outline-primary" onclick="window.open(\'' + app.jobUrl + '\', \'_blank\')" aria-label="Open job URL"><i class="fas fa-external-link-alt"></i></button>' : '-'}</td>
        <td class="text-nowrap"></td>
      `;
      const actionsCell = row.cells[10];

      if (app.notes) {
        const notesBtn = document.createElement('button');
        notesBtn.className = 'btn btn-sm btn-outline-info me-2';
        notesBtn.title = 'View Notes';
        notesBtn.setAttribute('aria-label', 'View notes for ' + app.company);
        notesBtn.innerHTML = '<i class="fas fa-sticky-note"></i>';
        notesBtn.addEventListener('click', () => alert(`Notes:\n\n${app.notes}`));
        actionsCell.appendChild(notesBtn);
      }

      if (app.attachments?.length) {
        const attachmentsBtn = document.createElement('button');
        attachmentsBtn.className = 'btn btn-sm btn-outline-secondary me-2';
        attachmentsBtn.title = `${app.attachments.length} Attachment(s)`;
        attachmentsBtn.setAttribute('aria-label', `View ${app.attachments.length} attachments for ${app.company}`);
        attachmentsBtn.innerHTML = '<i class="fas fa-paperclip"></i>';
        attachmentsBtn.addEventListener('click', () => showAttachmentsPopup(app.attachments));
        actionsCell.appendChild(attachmentsBtn);
      }

      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-sm btn-outline-warning me-2';
      editBtn.setAttribute('aria-label', 'Edit application for ' + app.company);
      editBtn.innerHTML = '<i class="fas fa-edit"></i>';
      editBtn.addEventListener('click', () => openEditModal(app));
      actionsCell.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-outline-danger';
      deleteBtn.setAttribute('aria-label', 'Delete application for ' + app.company);
      deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
      deleteBtn.addEventListener('click', () => deleteApplication(app.id));
      actionsCell.appendChild(deleteBtn);
    }

    function showAttachmentsPopup(attachments) {
      const popup = document.createElement('div');
      popup.className = 'card shadow';
      popup.style.position = 'absolute';
      popup.style.zIndex = '1000';
      popup.style.minWidth = '250px';
      popup.setAttribute('role', 'dialog');
      popup.setAttribute('aria-label', 'Attachments popup');

      const popupHeader = document.createElement('div');
      popupHeader.className = 'card-header bg-primary text-white';
      popupHeader.innerHTML = '<h6 class="mb-0">Attachments</h6>';

      const popupBody = document.createElement('div');
      popupBody.className = 'card-body p-2';

      attachments.forEach(attachment => {
        const item = document.createElement('div');
        item.className = 'attachment-item';
        item.innerHTML = `
          <i class="fas fa-paperclip attachment-icon"></i>
          <span class="text-truncate" style="max-width: 150px;">${attachment.name || 'Unnamed'}</span>
          <a href="${attachment.data}" download="${attachment.name}" class="btn btn-sm btn-link text-primary ms-auto" aria-label="Download ${attachment.name}">
            <i class="fas fa-download"></i>
          </a>
        `;
        popupBody.appendChild(item);
      });

      popup.appendChild(popupHeader);
      popup.appendChild(popupBody);

      const btn = event.currentTarget;
      const rect = btn.getBoundingClientRect();
      popup.style.left = `${rect.left}px`;
      popup.style.top = `${rect.bottom + 5}px`;

      document.body.appendChild(popup);

      const closePopup = (e) => {
        if (!popup.contains(e.target)) {
          document.body.removeChild(popup);
          document.removeEventListener('click', closePopup);
        }
      };

      setTimeout(() => document.addEventListener('click', closePopup), 100);
    }

    // Auto-Save Drafts
    function saveDraft(formId, fields) {
      if (formId !== 'jobForm') return;
      const formData = {};
      fields.forEach(field => {
        const el = document.getElementById(field);
        if (el) formData[field] = el.value;
      });
      localStorage.setItem(`${formId}Draft`, JSON.stringify(formData));
    }

    function loadDraft(formId, fields) {
      if (formId !== 'jobForm') return;
      const draft = JSON.parse(localStorage.getItem(`${formId}Draft`));
      if (draft && confirm(`Restore your previous new application draft?`)) {
        fields.forEach(field => {
          const el = document.getElementById(field);
          if (el && draft[field]) el.value = draft[field];
        });
      }
    }

    // Event Listeners
    function initEventListeners() {
      document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);
      recoveryBtn?.addEventListener('click', attemptRecovery);

      ['company', 'position', 'dateApplied', 'type'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', validateField);
        document.getElementById(`edit${id.charAt(0).toUpperCase() + id.slice(1)}`)?.addEventListener('input', validateField);
      });

      jobForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!jobForm.checkValidity()) {
          jobForm.classList.add('was-validated');
          showToast('Please fill all required fields', 'danger');
          return;
        }
        const newApp = {
          company: document.getElementById('company').value,
          position: document.getElementById('position').value,
          dateApplied: document.getElementById('dateApplied').value,
          type: document.getElementById('type').value,
          location: document.getElementById('location').value,
          salary: document.getElementById('salary').value || '-',
          jobSource: document.getElementById('jobSource').value,
          jobUrl: document.getElementById('jobUrl').value,
          notes: document.getElementById('notes').value,
          status: 'Applied',
          attachments: state.currentAttachments
        };
        try {
          await db.transaction('rw', db.applications, async () => {
            await db.applications.add(newApp);
          });
          jobForm.reset();
          jobForm.classList.remove('was-validated');
          state.currentAttachments = [];
          document.getElementById('attachmentsContainer').innerHTML = '';
          localStorage.removeItem('jobFormDraft');
          await loadApplications();
          showToast('Application added!', 'success');
        } catch (error) {
          console.error('Error adding application:', error);
          showToast('Failed to add application', 'danger');
        }
      });

      jobForm?.addEventListener('input', () => {
        clearTimeout(window.jobDraftTimer);
        window.jobDraftTimer = setTimeout(() => saveDraft('jobForm', ['company', 'position', 'dateApplied', 'type', 'location', 'salary', 'jobSource', 'jobUrl', 'notes']), 1000);
      });

      editForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!editForm.checkValidity()) {
          editForm.classList.add('was-validated');
          showToast('Please fill all required fields', 'danger');
          return;
        }
        const updatedApp = {
          company: document.getElementById('editCompany').value,
          position: document.getElementById('editPosition').value,
          dateApplied: document.getElementById('editDateApplied').value,
          type: document.getElementById('editType').value,
          location: document.getElementById('editLocation').value,
          salary: document.getElementById('editSalary').value || '-',
          jobSource: document.getElementById('editJobSource').value,
          jobUrl: document.getElementById('editJobUrl').value,
          notes: document.getElementById('editNotes').value,
          status: document.getElementById('editStatus').value,
          attachments: state.editAttachments
        };
        try {
          await db.transaction('rw', db.applications, async () => {
            await db.applications.update(state.currentEditId, updatedApp);
          });
          editModal.hide();
          editForm.classList.remove('was-validated');
          await loadApplications();
          showToast('Application updated!', 'success');
        } catch (error) {
          console.error('Error updating application:', error);
          showToast('Failed to update application', 'danger');
        }
      });

      const dropzone = document.getElementById('attachmentDropzone');
      const dropzoneInput = document.getElementById('attachmentInput');
      dropzone?.addEventListener('click', () => dropzoneInput.click());
      dropzone?.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
      dropzone?.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
      dropzone?.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        handleFileSelect({ target: { files: e.dataTransfer.files } });
      });
      dropzoneInput?.addEventListener('change', handleFileSelect);

      const editDropzone = document.getElementById('editAttachmentDropzone');
      const editDropzoneInput = document.getElementById('editAttachmentInput');
      editDropzone?.addEventListener('click', () => editDropzoneInput.click());
      editDropzone?.addEventListener('dragover', (e) => { e.preventDefault(); editDropzone.classList.add('dragover'); });
      editDropzone?.addEventListener('dragleave', () => editDropzone.classList.remove('dragover'));
      editDropzone?.addEventListener('drop', (e) => {
        e.preventDefault();
        editDropzone.classList.remove('dragover');
        handleEditFileSelect({ target: { files: e.dataTransfer.files } });
      });
      editDropzoneInput?.addEventListener('change', handleEditFileSelect);

      let debounceTimer;
      document.getElementById('searchInput')?.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => filterApplications(e.target.value), 300);
      });
      document.getElementById('clearSearch')?.addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        filterApplications('');
      });

      document.getElementById('backupDataBtn')?.addEventListener('click', async () => {
        document.getElementById('loadingSpinner').classList.remove('d-none');
        await createBackup(true);
        document.getElementById('loadingSpinner').classList.add('d-none');
      });

      document.getElementById('importDataBtn')?.addEventListener('click', () => document.getElementById('importFileInput').click());
      document.getElementById('importFileInput')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (event) => {
            try {
              const apps = JSON.parse(event.target.result);
              if (Array.isArray(apps)) {
                await db.transaction('rw', db.applications, async () => {
                  await db.applications.clear();
                  await db.applications.bulkAdd(apps);
                });
                showToast(`Imported ${apps.length} applications!`, 'success');
                await loadApplications();
              } else {
                showToast('Invalid JSON format', 'danger');
              }
            } catch (error) {
              console.error('Import error:', error);
              showToast('Failed to import data: ' + error.message, 'danger');
            }
          };
          reader.onerror = () => showToast('Error reading file', 'danger');
          reader.readAsText(file);
        }
      });

      document.getElementById('exportJSON')?.addEventListener('click', async () => {
        try {
          const apps = await db.applications.toArray();
          const jsonString = JSON.stringify(apps, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'job-applications.json';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          showToast(`Exported ${apps.length} applications`, 'success');
        } catch (error) {
          console.error('Export JSON error:', error);
          showToast('Export failed: ' + error.message, 'danger');
        }
      });

      document.getElementById('exportPDF')?.addEventListener('click', exportToPDF);

      document.getElementById('goalForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const totalGoal = parseInt(document.getElementById('totalGoalInput').value);
        const weeklyGoal = parseInt(document.getElementById('weeklyGoalInput').value);
        const monthlyGoal = parseInt(document.getElementById('monthlyGoalInput').value);
        if (isNaN(totalGoal) || isNaN(weeklyGoal) || isNaN(monthlyGoal) || totalGoal < 1 || weeklyGoal < 1 || monthlyGoal < 1) {
          document.getElementById('goalForm').classList.add('was-validated');
          return;
        }
        state.goals = { totalGoal, weeklyGoal, monthlyGoal };
        await db.transaction('rw', db.goals, async () => {
          await db.goals.put({ id: 1, totalGoal, weeklyGoal, monthlyGoal });
        });
        updateGoalDisplay();
        updateProgressBars();
        goalModal.hide();
        document.getElementById('goalForm').classList.remove('was-validated');
        showToast('Goals updated successfully!', 'success');
      });

      document.getElementById('analytics-tab')?.addEventListener('shown.bs.tab', () => {
        Object.values(state.charts).forEach(chart => chart?.resize());
      });
      ['analyticsStartDate', 'analyticsEndDate'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateCharts);
      });
      document.getElementById('exportStatusChart')?.addEventListener('click', () => exportChart(state.charts.status, 'status-chart.png'));

      document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
        document.getElementById('analyticsStartDate').value = '';
        document.getElementById('analyticsEndDate').value = '';
        updateCharts();
        showToast('Filters cleared', 'info');
      });

      // Keyboard Shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 's') {
          e.preventDefault();
          if (editModal._isShown) editForm.dispatchEvent(new Event('submit'));
          else jobForm.dispatchEvent(new Event('submit'));
        }
        if (e.ctrlKey && e.key === 'n') {
          e.preventDefault();
          document.getElementById('company').focus();
        }
      });

      document.getElementById('recoverFromOldDb')?.addEventListener('click', async () => {
        try {
          const backups = await db.backups.orderBy('timestamp').reverse().toArray();
          if (backups.length) {
            state.recoveryData = JSON.parse(backups[0].data);
            showRecoveryPreview(state.recoveryData);
          } else {
            showToast('No database backups found', 'warning');
          }
        } catch (error) {
          console.error('Error recovering from DB:', error);
          showToast('Recovery failed', 'danger');
        }
      });

      document.getElementById('recoverFromLocalStorage')?.addEventListener('click', () => {
        try {
          const backup = localStorage.getItem('jobTrackerBackup');
          if (backup) {
            state.recoveryData = JSON.parse(backup);
            showRecoveryPreview(state.recoveryData);
          } else {
            showToast('No local storage backup found', 'warning');
          }
        } catch (error) {
          console.error('Error recovering from local storage:', error);
          showToast('Recovery failed', 'danger');
        }
      });

      document.getElementById('confirmRecovery')?.addEventListener('click', async () => {
        if (!state.recoveryData) return;
        try {
          await db.transaction('rw', db.applications, async () => {
            await db.applications.clear();
            await db.applications.bulkAdd(state.recoveryData);
          });
          recoveryModal.hide();
          await loadApplications();
          showToast('Data recovered successfully!', 'success');
        } catch (error) {
          console.error('Error applying recovery:', error);
          showToast('Failed to recover data', 'danger');
        }
      });
    }

    function showRecoveryPreview(data) {
      document.getElementById('recoveryOptions').classList.add('d-none');
      document.getElementById('recoveryResults').classList.remove('d-none');
      document.getElementById('recoveredAppCount').textContent = data.length;
      const earliest = data.reduce((min, app) => {
        const date = new Date(app.dateApplied);
        return date < min ? date : min;
      }, new Date());
      document.getElementById('earliestDate').textContent = earliest.toLocaleDateString();
    }

    function validateField(e) {
      const input = e.target;
      const isValid = !!input.value;
      input.classList.toggle('is-invalid', !isValid && input.required);
      input.classList.toggle('is-valid', isValid);
    }

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      const container = document.getElementById('attachmentsContainer');
      container.innerHTML = '';
      state.currentAttachments = [];

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const attachment = {
            name: file.name,
            type: file.type,
            size: file.size,
            data: event.target.result
          };
          if (!state.currentAttachments.some(a => a.name === attachment.name)) {
            state.currentAttachments.push(attachment);
            renderAttachmentItem(container, attachment, 'current');
          }
        };
        reader.readAsDataURL(file);
      });
    }

    function handleEditFileSelect(e) {
      const files = Array.from(e.target.files);
      const container = document.getElementById('editAttachmentsContainer');

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const attachment = {
            name: file.name,
            type: file.type,
            size: file.size,
            data: event.target.result
          };
          if (!state.editAttachments.some(a => a.name === attachment.name)) {
            state.editAttachments.push(attachment);
            renderAttachmentItem(container, attachment, 'edit');
          }
        };
        reader.readAsDataURL(file);
      });
    }

    function renderAttachmentItem(container, attachment, type) {
      const item = document.createElement('div');
      item.className = 'attachment-item';
      item.innerHTML = `
        <i class="fas fa-paperclip attachment-icon"></i>
        <span>${attachment.name}</span>
        <a href="${attachment.data}" download="${attachment.name}" class="btn btn-sm btn-link text-primary ms-auto" aria-label="Download ${attachment.name}">
          <i class="fas fa-download"></i>
        </a>
        <button class="btn btn-sm btn-link text-danger" data-name="${attachment.name}" aria-label="Remove ${attachment.name}">
          <i class="fas fa-times"></i>
        </button>
      `;
      item.querySelector('button').addEventListener('click', (e) => {
        e.preventDefault();
        if (type === 'current') {
          state.currentAttachments = state.currentAttachments.filter(a => a.name !== attachment.name);
        } else {
          state.editAttachments = state.editAttachments.filter(a => a.name !== attachment.name);
        }
        container.removeChild(item);
      });
      container.appendChild(item);
    }
    // Utility Functions
    function showToast(message, type) {
      const toastEl = document.createElement('div');
      toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
      toastEl.setAttribute('role', 'alert');
      toastEl.setAttribute('aria-live', 'assertive');
      toastEl.setAttribute('aria-atomic', 'true');
      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      toastContainer.appendChild(toastEl);
      const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
      toast.show();
      toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    function filterApplications(searchTerm) {
      state.filteredApplications = state.applications.filter(app => {
        const matchesSearch = !searchTerm || (
          app.company?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          app.position?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          app.location?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          app.notes?.toLowerCase().includes(searchTerm.toLowerCase()) ||
          app.jobUrl?.toLowerCase().includes(searchTerm.toLowerCase())
        );
        return matchesSearch;
      });
      state.currentPage = 1;
      renderApplicationsTable();
      renderPagination();
    }

    function renderPagination() {
      if (!pagination) return;
      pagination.innerHTML = '';
      const totalPages = Math.ceil(state.filteredApplications.length / state.itemsPerPage);

      if (totalPages <= 1) return;

      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${state.currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous page">Previous</a>`;
      prevLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (state.currentPage > 1) {
          state.currentPage--;
          renderApplicationsTable();
          renderPagination();
        }
      });
      pagination.appendChild(prevLi);

      for (let i = 1; i <= totalPages; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === state.currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" aria-label="Page ${i}">${i}</a>`;
        pageLi.addEventListener('click', (e) => {
          e.preventDefault();
          state.currentPage = i;
          renderApplicationsTable();
          renderPagination();
        });
        pagination.appendChild(pageLi);
      }

      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${state.currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next page">Next</a>`;
      nextLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (state.currentPage < totalPages) {
          state.currentPage++;
          renderApplicationsTable();
          renderPagination();
        }
      });
      pagination.appendChild(nextLi);
    }

    async function openEditModal(app) {
      state.currentEditId = app.id;
      state.editAttachments = app.attachments ? [...app.attachments] : [];
      document.getElementById('editCompany').value = app.company || '';
      document.getElementById('editPosition').value = app.position || '';
      document.getElementById('editDateApplied').value = app.dateApplied || '';
      document.getElementById('editType').value = app.type || 'Remote';
      document.getElementById('editStatus').value = app.status || 'Applied';
      document.getElementById('editLocation').value = app.location || '';
      document.getElementById('editSalary').value = app.salary === '-' ? '' : app.salary || '';
      document.getElementById('editJobSource').value = app.jobSource || '';
      document.getElementById('editJobUrl').value = app.jobUrl || '';
      document.getElementById('editNotes').value = app.notes || '';

      const container = document.getElementById('editAttachmentsContainer');
      container.innerHTML = '';
      state.editAttachments.forEach(attachment => renderAttachmentItem(container, attachment, 'edit'));
      editModal.show();
    }

    async function deleteApplication(id) {
      if (confirm('Are you sure you want to delete this application? This action cannot be undone.')) {
        try {
          await db.transaction('rw', db.applications, async () => {
            await db.applications.delete(id);
          });
          await loadApplications();
          showToast('Application deleted', 'success');
        } catch (error) {
          console.error('Error deleting application:', error);
          showToast('Failed to delete application', 'danger');
        }
      }
    }

    function exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20);
        doc.text('Job Applications', 105, 15, { align: 'center' });
        const headers = ['#', 'Date', 'Company', 'Position', 'Type', 'Location', 'Salary', 'Source', 'Status', 'URL'];
        const data = state.filteredApplications.map((app, i) => {
          const dateApplied = new Date(app.dateApplied);
          const formattedDate = new Date(dateApplied.getTime() + dateApplied.getTimezoneOffset() * 60000).toLocaleDateString();
          return [
            i + 1,
            formattedDate,
            app.company || '-',
            app.position || '-',
            app.type || '-',
            app.location || '-',
            app.salary || '-',
            app.jobSource || '-',
            app.status || '-',
            app.jobUrl || '-'
          ];
        });
        doc.autoTable({
          head: [headers],
          body: data,
          startY: 25,
          styles: { fontSize: 8, cellPadding: 2 },
          headStyles: { fillColor: [74, 94, 84], textColor: 255 },
          alternateRowStyles: { fillColor: [245, 250, 251] }
        });
        doc.save('job-applications.pdf');
        showToast('PDF exported successfully', 'success');
      } catch (error) {
        console.error('PDF export error:', error);
        showToast('PDF export failed: ' + error.message, 'danger');
      }
    }

    // Backup System
    function setupAutoBackup() {
      setInterval(() => createBackup(false), 3600000); // Hourly backup
      window.addEventListener('beforeunload', () => createBackup(false));
      createBackup(false);
    }

    async function createBackup(download = false) {
      try {
        await db.transaction('r', db.applications, async () => {
          const apps = await db.applications.toArray();
          const timestamp = new Date().toISOString();
          const backupData = JSON.stringify(apps);
          await db.transaction('rw', db.backups, async () => {
            await db.backups.add({ timestamp, data: backupData });
          });
          const essentialData = apps.map(app => ({
            id: app.id, company: app.company, dateApplied: app.dateApplied, status: app.status
          }));
          localStorage.setItem('jobTrackerBackup', JSON.stringify(essentialData));
          if (download) {
            const blob = new Blob([backupData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `job-applications-backup-${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('Backup saved successfully', 'success');
          }
        });
      } catch (error) {
        console.error('Backup error:', error);
        if (download) showToast('Failed to save backup', 'danger');
      }
    }

    // Analytics Charts
    function setupCharts() {
      Object.values(state.charts).forEach(chart => chart?.destroy());
      state.charts = {};

      const textColor = document.body.dataset.theme === 'dark' ? '#E5E5E5' : '#333333';

      const statusCtx = document.getElementById('statusChart')?.getContext('2d');
      if (statusCtx) {
        state.charts.status = new Chart(statusCtx, {
          type: 'doughnut',
          data: {
            labels: state.statuses,
            datasets: [{
              data: [0, 0, 0, 0],
              backgroundColor: ['#4A5E54', '#17A2B8', '#28A745', '#DC3545'],
              borderWidth: 1,
              borderColor: textColor
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.2,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: textColor, padding: 15, boxWidth: 20 }
              },
              tooltip: {
                backgroundColor: document.body.dataset.theme === 'dark' ? '#34495E' : '#FFFFFF',
                titleColor: textColor,
                bodyColor: textColor
              }
            },
            animation: { duration: 1000 },
            accessibility: { enabled: true }
          }
        });
      }

      const typeCtx = document.getElementById('typeChart')?.getContext('2d');
      if (typeCtx) {
        state.charts.type = new Chart(typeCtx, {
          type: 'bar',
          data: {
            labels: state.jobTypes,
            datasets: [{
              label: 'Applications',
              data: [0, 0, 0],
              backgroundColor: ['#FF9F40', '#36A2EB', '#9966FF'],
              borderWidth: 1,
              borderColor: textColor
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.2,
            scales: {
              x: { ticks: { color: textColor }, grid: { display: false } },
              y: {
                beginAtZero: true,
                ticks: { color: textColor, precision: 0 },
                grid: { color: document.body.dataset.theme === 'dark' ? '#465C71' : '#E5E5E5' }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: document.body.dataset.theme === 'dark' ? '#34495E' : '#FFFFFF',
                titleColor: textColor,
                bodyColor: textColor
              }
            },
            animation: { duration: 1000 },
            accessibility: { enabled: true }
          }
        });
      }

      const sourceSuccessCtx = document.getElementById('sourceSuccessChart')?.getContext('2d');
      if (sourceSuccessCtx) {
        state.charts.sourceSuccess = new Chart(sourceSuccessCtx, {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'Success Rate (%)',
              data: [],
              backgroundColor: '#FF6384',
              borderWidth: 1,
              borderColor: textColor
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.2,
            scales: {
              x: { ticks: { color: textColor }, grid: { display: false } },
              y: {
                beginAtZero: true,
                max: 100,
                ticks: { color: textColor, stepSize: 20 },
                grid: { color: document.body.dataset.theme === 'dark' ? '#465C71' : '#E5E5E5' }
              }
            },
            plugins: {
              legend: { position: 'top', labels: { color: textColor } },
              tooltip: {
                backgroundColor: document.body.dataset.theme === 'dark' ? '#34495E' : '#FFFFFF',
                titleColor: textColor,
                bodyColor: textColor,
                callbacks: { label: context => `${context.raw.toFixed(1)}%` }
              }
            },
            animation: { duration: 1000 },
            accessibility: { enabled: true }
          }
        });
      }
    }

    function updateCharts() {
      const start = new Date(document.getElementById('analyticsStartDate')?.value || '1900-01-01');
      const end = new Date(document.getElementById('analyticsEndDate')?.value || '9999-12-31');
      const filteredApps = state.filteredApplications.filter(app => {
        const date = new Date(app.dateApplied);
        return date >= start && date <= end;
      });

      if (state.charts.status) {
        state.charts.status.data.datasets[0].data = state.statuses.map(s => filteredApps.filter(a => a.status === s).length);
        state.charts.status.update();
      }

      if (state.charts.type) {
        state.charts.type.data.datasets[0].data = state.jobTypes.map(t => filteredApps.filter(a => a.type === t).length);
        state.charts.type.update();
      }

      if (state.charts.sourceSuccess) {
        const sources = [...new Set(filteredApps.map(app => app.jobSource || 'Unknown'))];
        const successRates = sources.map(source => {
          const apps = filteredApps.filter(app => (app.jobSource || 'Unknown') === source);
          const offers = apps.filter(app => app.status === 'Offer').length;
          return apps.length ? (offers / apps.length) * 100 : 0;
        });
        state.charts.sourceSuccess.data.labels = sources;
        state.charts.sourceSuccess.data.datasets[0].data = successRates;
        state.charts.sourceSuccess.update();
      }

      const offerCount = filteredApps.filter(a => a.status === 'Offer').length;
      const total = filteredApps.length;
      document.getElementById('successRate').textContent = total ? `${Math.round((offerCount / total) * 100)}%` : '0%';

      const appliedToInterviewTimes = filteredApps
        .filter(app => app.status === 'Interview')
        .map(app => {
          const appliedDate = new Date(app.dateApplied);
          return (new Date() - appliedDate) / (1000 * 60 * 60 * 24);
        });
      const avgTime = appliedToInterviewTimes.length
        ? Math.round(appliedToInterviewTimes.reduce((a, b) => a + b, 0) / appliedToInterviewTimes.length)
        : '-';
      document.getElementById('avgResponseTime').textContent = avgTime === '-' ? '-' : `${avgTime} days`;
    }

    function exportChart(chart, filename) {
      if (!chart) {
        showToast('Chart not available', 'danger');
        return;
      }
      try {
        const link = document.createElement('a');
        link.href = chart.toBase64Image();
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Chart exported successfully', 'success');
      } catch (error) {
        console.error('Chart export error:', error);
        showToast('Chart export failed: ' + error.message, 'danger');
      }
    }
    </script>
    </body>
    </html>